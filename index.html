<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spektra install - Protokol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Montserrat:ital,wght@0,900;1,900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #000; }
        input[type="text"], input[type="date"], input[type="email"], select, textarea { border: none; background: transparent; outline: none; width: 100%; font-family: inherit; }
        .checkbox-custom { width: 16px; height: 16px; accent-color: #000; border: 1px solid #000; }
        .form-box { border: 1px solid #cbd5e1; padding: 12px; border-radius: 4px; background: #fff; }
        .form-box h3 { font-size: 11px; font-weight: 800; text-transform: uppercase; margin-bottom: 8px; color: #1e293b; border-bottom: 1px solid #f1f5f9; padding-bottom: 4px;}
        .form-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; font-size: 11px; }
        .form-row span { color: #475569; width: 120px; flex-shrink: 0; }
        .form-row input { font-weight: 700; text-align: right; }
        .section-title { font-size: 12px; font-weight: 800; text-transform: uppercase; color: #000; border-left: 3px solid #dc2626; padding-left: 8px; margin: 15px 0 8px 0; display: flex; align-items: center; gap: 8px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 12px; }
        .data-table th, .data-table td { border: 1px solid #cbd5e1; padding: 4px 6px; text-align: left; }
        .data-table th { background-color: #f8fafc; font-weight: 800; }
        .signature-line { border-top: 1px solid #000; width: 100%; text-align: center; font-size: 10px; font-weight: 700; padding-top: 4px; }
        .signature-pad { border: 1px dashed #cbd5e1; background: #fafafa; width: 100%; height: 70px; touch-action: none; }

        /* Foto mrie≈æka */
        .photo-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .photo-item { border: 1px solid #cbd5e1; position: relative; aspect-ratio: 4/3; overflow: hidden; background: #eee; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }

        @media print {
            @page { size: A4 portrait; margin: 10mm; }
            body { background: white; font-size: 9pt; }
            .no-print { display: none !important; }
            .page-container { border: none; box-shadow: none; width: 100%; padding: 0; }
            .print-grid-2 { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 10px; }
            /* Vyn√∫tenie novej strany pre fotky */
            .photo-section { page-break-before: always; margin-top: 20mm; }
            .photo-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 5mm !important; }
            .photo-item { border: 1px solid #000; }
        }

        #toast { visibility: hidden; min-width: 250px; background: #1e293b; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 10000; left: 50%; bottom: 30px; transform: translateX(-50%); font-weight: bold; }
        #toast.show { visibility: visible; animation: fadein 0.4s, fadeout 0.4s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        .device-section { display: none; }
        .device-section.active { display: block; }
        .status-badge { display: inline-flex; align-items: center; gap: 4px; font-size: 9px; font-weight: 700; text-transform: uppercase; color: #64748b; }
        .pulse { width: 6px; height: 6px; border-radius: 50%; background-color: #22c55e; animation: pulse-animation 2s infinite; }
        @keyframes pulse-animation { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 4px rgba(34, 197, 94, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
    </style>
</head>
<body class="p-0 md:p-6">
    <div id="toast">Spr√°va</div>

    <div class="page-container max-w-[850px] mx-auto bg-white shadow-2xl p-6 md:p-10 min-h-screen border border-slate-200">
        
        <div class="flex flex-col md:flex-row justify-between items-end border-b-[3px] border-red-600 pb-3 mb-6 gap-4 print:flex-row print:justify-between">
            <div class="w-full md:w-1/3">
                <h1 class="text-3xl tracking-tighter uppercase font-black" style="font-family: 'Montserrat', sans-serif;">SPEKTRA <span class="text-red-600">INSTALL</span></h1>
                <p class="text-[9px] text-slate-500 leading-tight">Holl√©ho 210, 015 01 Rajec | IƒåO: 535690036</p>
                <div id="authStatusContainer" class="mt-2 no-print"><div id="authBadge" class="status-badge"><div id="authDot" class=""></div><span id="authText">Prip√°janie...</span></div></div>
            </div>
            <div class="w-full md:w-1/3 text-center">
                <select id="deviceSelector" onchange="updateDeviceView()" class="no-print border border-slate-300 rounded px-2 py-1 text-xs font-bold text-red-600 bg-slate-50 cursor-pointer">
                    <option value="tc">Tepeln√© ƒçerpadlo</option>
                    <option value="plyn">Plynov√Ω kotol</option>
                    <option value="elektro">Elektrick√Ω kotol</option>
                    <option value="pevne">Kotol na pevn√© palivo</option>
                </select>
                <div id="printDeviceName" class="hidden print:block font-black text-red-600 text-[14px] uppercase tracking-widest">Tepeln√© ƒçerpadlo</div>
            </div>
            <div class="w-full md:w-1/3 text-right">
                <h2 class="font-black text-[13px] uppercase">Sp√∫≈°≈•ac√≠ protokol</h2>
                <div class="border-[2px] border-black px-2 py-1 inline-flex items-center bg-white font-bold text-[12px]">
                    <span>ƒå√≠slo: </span>
                    <input type="text" id="protocolId" class="w-24 ml-2 font-black text-red-600 text-right" value="SP-2026/001">
                </div>
            </div>
        </div>

        <form id="protocolForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 print-grid-2">
                <div class="form-box">
                    <h3>ZHOTOVITEƒΩ</h3>
                    <div class="form-row"><span>Spoloƒçnos≈•:</span> <input type="text" id="inst_company" value="Spektra install s.r.o."></div>
                    <div class="form-row"><span>Technik:</span> <input type="text" id="inst_elec" value="¬ß22 ƒç.o. 18122868"></div>
                    <div class="form-row"><span>D√°tum:</span> <input type="date" id="date_inst" value="2026-02-27"></div>
                </div>
                <div class="form-box">
                    <h3>PREV√ÅDZKOVATEƒΩ</h3>
                    <div class="form-row"><span>Meno:</span> <input type="text" id="customer" placeholder="Meno z√°kazn√≠ka"></div>
                    <div class="form-row"><span>Adresa:</span> <input type="text" id="address" placeholder="Adresa"></div>
                    <div class="form-row"><span>Mobil:</span> <input type="text" id="phone" placeholder="+421"></div>
                </div>
            </div>

            <div id="section-tc" class="device-section active">
                <div class="section-title">1. √ödaje o zariaden√≠ a merania (Tƒå)</div>
                <table class="data-table">
                    <thead><tr><th>ƒåas≈•</th><th>Model</th><th>S√©riov√© ƒç√≠slo</th></tr></thead>
                    <tbody>
                        <tr><td>Vonkaj≈°ia j.</td><td><input type="text" id="model_ext"></td><td><input type="text" id="sn_ext"></td></tr>
                        <tr><td>Vn√∫torn√° j.</td><td><input type="text" id="model_int"></td><td><input type="text" id="sn_int"></td></tr>
                    </tbody>
                </table>
                </div>

            <div id="section-plyn" class="device-section">
                <div class="section-title">1. √ödaje o zariaden√≠ a merania (Plyn)</div>
                <table class="data-table">
                    <thead><tr><th>Predmet kontroly</th><th>Nameran√©</th><th>Stav</th></tr></thead>
                    <tbody>
                        <tr><td>Tlak plynu</td><td><input type="text" id="g_tlak"></td><td>Vyhovuje</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="section-title">Z√°ver a podpisy</div>
            <div class="border-2 border-green-600 py-2 text-center my-4 bg-green-50 font-bold uppercase text-xs text-green-700">
                Zariadenie je sp√¥sobil√© bezpeƒçnej prev√°dzky
            </div>

            <div class="grid grid-cols-3 gap-6 mt-6 items-end">
                <div class="text-center"><div id="sig_date_display" class="font-bold text-xs mb-1">27.02.2026</div><div class="signature-line">D√°tum</div></div>
                <div class="relative text-center">
                    <canvas id="customerSignature" class="signature-pad"></canvas>
                    <button type="button" onclick="clearSignature('customerSignature')" class="no-print absolute -top-4 left-0 text-[8px] bg-slate-200 px-1">Zmaza≈•</button>
                    <div class="signature-line">Podpis z√°kazn√≠ka</div>
                </div>
                <div class="relative text-center">
                    <img src="Razitko a podpis.jpg" alt="Raz√≠tko" class="h-16 mx-auto mix-blend-multiply" onerror="this.style.display='none'">
                    <div class="signature-line">Technik (Spektra)</div>
                </div>
            </div>

            <div class="photo-section">
                <div class="section-title">Fotodokument√°cia in≈°tal√°cie</div>
                <div class="no-print mb-4 p-4 border-2 border-dashed border-red-200 rounded bg-red-50 text-center">
                    <label class="cursor-pointer bg-red-600 text-white px-4 py-2 rounded font-bold text-xs uppercase shadow-md">
                        üì∏ Prida≈• fotografiu
                        <input type="file" id="photoInput" accept="image/*" class="hidden" multiple onchange="handlePhotos(event)">
                    </label>
                    <p class="text-[10px] text-slate-500 mt-2">Fotky sa pri tlaƒçi automaticky presun√∫ na stranu ƒç. 2</p>
                </div>
                <div id="photoGallery" class="photo-grid">
                    </div>
            </div>

            <div class="mt-12 no-print flex justify-center gap-4 pb-10">
                <button type="button" id="btnSave" class="bg-black text-white px-6 py-3 rounded font-bold text-xs uppercase tracking-widest">üíæ Ulo≈æi≈•</button>
                <button type="button" onclick="window.print()" class="bg-red-600 text-white px-6 py-3 rounded font-bold text-xs uppercase tracking-widest">üñ®Ô∏è PDF Protokol</button>
            </div>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCiKb3ZKYaTUxdtiJMI2E9QvTaEIpIHr9U", authDomain: "spustaci-protokol.firebaseapp.com", projectId: "spustaci-protokol", storageBucket: "spustaci-protokol.firebasestorage.app", messagingSenderId: "860586673764", appId: "1:860586673764:web:f32fd0b6a33dbf75bec171" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userPhotos = [];

        // Pr√°ca s fotkami
        window.handlePhotos = (event) => {
            const files = event.target.files;
            const gallery = document.getElementById('photoGallery');
            
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result;
                    userPhotos.push(base64);
                    renderGallery();
                };
                reader.readAsDataURL(file);
            }
        };

        function renderGallery() {
            const gallery = document.getElementById('photoGallery');
            gallery.innerHTML = '';
            userPhotos.forEach((src, index) => {
                const div = document.createElement('div');
                div.className = 'photo-item group';
                div.innerHTML = `
                    <img src="${src}">
                    <button type="button" onclick="removePhoto(${index})" class="no-print absolute top-1 right-1 bg-red-600 text-white w-5 h-5 rounded-full text-[10px] font-bold">X</button>
                `;
                gallery.appendChild(div);
            });
        }

        window.removePhoto = (index) => {
            userPhotos.splice(index, 1);
            renderGallery();
        };

        // Signature logic
        const canvas = document.getElementById('customerSignature');
        const ctx = canvas.getContext('2d');
        let drawing = false;
        canvas.width = 200; canvas.height = 70;
        ctx.strokeStyle = "#000"; ctx.lineWidth = 2;
        
        const getPos = (e) => {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            return { x: clientX - rect.left, y: clientY - rect.top };
        };
        canvas.addEventListener('mousedown', (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); });
        canvas.addEventListener('mousemove', (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); });
        window.addEventListener('mouseup', () => drawing = false);
        canvas.addEventListener('touchstart', (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); e.preventDefault(); }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); }, {passive: false});

        window.clearSignature = () => ctx.clearRect(0,0,canvas.width,canvas.height);

        // Firebase ukladanie
        document.getElementById('btnSave').onclick = async () => {
            const pId = document.getElementById('protocolId').value;
            if(!pId) return alert("Zadajte ƒç√≠slo protokolu");
            
            const data = {
                content: {},
                signature: canvas.toDataURL(),
                photos: userPhotos,
                type: document.getElementById('deviceSelector').value
            };
            
            document.querySelectorAll('input, select, textarea').forEach(el => { if(el.id) data.content[el.id] = el.type === 'checkbox' ? el.checked : el.value; });

            try {
                await setDoc(doc(db, "protocols", pId), data);
                showToast("‚úÖ Ulo≈æen√©!");
            } catch (e) { alert(e.message); }
        };

        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.className = 'show'; setTimeout(() => t.className = '', 3000); }
        
        window.updateDeviceView = () => {
            const val = document.getElementById('deviceSelector').value;
            document.querySelectorAll('.device-section').forEach(s => s.classList.remove('active'));
            document.getElementById('section-' + val).classList.add('active');
            document.getElementById('printDeviceName').innerText = document.getElementById('deviceSelector').options[document.getElementById('deviceSelector').selectedIndex].text;
        };
        
        signInAnonymously(auth).then(() => {
            document.getElementById('authBadge').innerHTML = '<div class="pulse"></div> Cloud OK';
        });
    </script>
</body>
</html>
