<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spektra install - Protokol o odovzdaní zariadenia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .page-container { 
                border: none !important; 
                box-shadow: none !important; 
                width: 100%; 
                max-width: 100%; 
                margin: 0; 
                padding: 4mm;
            }
            .section-header { 
                background-color: #f8fafc !important; 
                color: #e11d48 !important; 
                border-bottom: 2px solid #e11d48 !important;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            input, select, textarea { 
                border: none !important; 
                background: transparent !important; 
                appearance: none;
            }
            .device-section { display: none; }
            .device-section.active { display: block !important; }
            canvas { border: 1px solid #eee !important; }
        }

        .section-header { 
            background-color: #f1f5f9; 
            color: #e11d48; 
            padding: 8px 12px; 
            font-weight: 900; 
            text-transform: uppercase; 
            font-size: 11px; 
            letter-spacing: 0.8px; 
            border-left: 5px solid #e11d48; 
            margin-top: 16px; 
            margin-bottom: 8px;
        }

        .input-field { 
            border: 1px solid #e2e8f0; 
            padding: 8px 10px; 
            font-size: 16px; 
            width: 100%; 
            border-radius: 6px; 
            outline: none; 
            background-color: #ffffff;
        }

        @media (min-width: 768px) {
            .input-field { font-size: 13px; padding: 4px 8px; }
            .section-header { font-size: 10px; padding: 4px 12px; }
        }

        .label-text { 
            font-size: 10px; 
            font-weight: 800; 
            color: #64748b; 
            text-transform: uppercase; 
            margin-bottom: 3px;
            display: block;
        }

        .checkbox-custom {
            width: 22px;
            height: 22px;
            accent-color: #e11d48;
        }

        .device-section { display: none; }
        .device-section.active { display: block; }

        .measuring-table th { font-size: 9px; background: #f8fafc; padding: 6px; text-align: center; border: 1px solid #e2e8f0; }
        .measuring-table td { border: 1px solid #e2e8f0; padding: 4px; }
        .measuring-table input { text-align: center; font-weight: bold; font-size: 14px; width: 100%; }

        .signature-pad {
            border: 2px solid #e2e8f0;
            background-color: #ffffff;
            width: 100%;
            height: 180px;
            cursor: crosshair;
            touch-action: none;
            border-radius: 8px;
        }

        #deviceSelector {
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }

        /* Toast notifications */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #334155;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            font-weight: bold;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body class="p-0 md:p-4">

    <div id="toast">Správa</div>

    <div class="page-container max-w-[900px] mx-auto bg-white shadow-xl border-t-[8px] border-red-600 p-4 md:p-10 min-h-screen rounded-b-lg">
        
        <!-- HLAVIČKA FIRMY -->
        <div class="flex flex-col md:flex-row justify-between items-start border-b border-zinc-200 pb-6 mb-4">
            <div class="flex flex-col md:flex-row gap-5 w-full md:w-auto">
                <div>
                    <h1 class="text-red-600 font-[900] text-3xl italic leading-none tracking-tighter uppercase">SPEKTRA <span class="text-slate-700 font-black">install</span></h1>
                    <p class="text-[10px] font-extrabold uppercase tracking-[0.1em] text-slate-400 mt-1 italic leading-none">Váš partner pre tepelné čerpadlá a kotly</p>
                </div>
                <div class="text-[10px] md:text-[8.5px] text-slate-500 md:border-l md:pl-4 border-slate-200 leading-tight space-y-1">
                    <p class="font-black text-slate-700 uppercase text-[11px] md:text-[9.5px]">Spektra install s.r.o.</p>
                    <p>Prevádzka: Hollého 210, 015 01 Rajec</p>
                    <p>IČO: 535690036 | Email: spektrainstall@gmail.com</p>
                    <div class="flex items-center gap-1 mt-2 font-bold text-red-600 uppercase tracking-tighter">
                        <span>Č. protokolu:</span>
                        <input type="text" id="protocolId" class="bg-red-50 px-2 py-1 rounded border-none outline-none w-32 font-black text-red-700 text-sm md:text-base" value="POZ2026001">
                    </div>
                </div>
            </div>
            <div class="text-left md:text-right mt-6 md:mt-0 w-full md:w-auto">
                <h2 class="text-lg font-black uppercase text-slate-800 tracking-tight leading-none mb-3 md:mb-2">Protokol o odovzdaní</h2>
                <div class="flex flex-col md:items-end gap-1.5">
                    <span class="text-[9px] font-bold text-slate-400 uppercase mb-0.5">Zvoľte Typ zariadenia:</span>
                    <select id="deviceSelector" onchange="updateDeviceView()" class="w-full md:w-auto font-black text-red-600 border-2 border-red-600 rounded-lg px-4 py-3 md:px-2 md:py-1 italic bg-white outline-none text-base md:text-[12px] cursor-pointer shadow-sm">
                        <option value="tc">Tepelné čerpadlo</option>
                        <option value="plyn">Plynový kotol</option>
                        <option value="elektro">Elektrický kotol</option>
                        <option value="pelety">Peletový kotol</option>
                    </select>
                </div>
            </div>
        </div>

        <form id="protocolForm">
            <!-- 01. VŠEOBECNÉ INFO -->
            <div class="section-header">01. Všeobecné informácie</div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-1.5">
                <div><label class="label-text">Dátum spustenia</label><input type="date" id="date" class="input-field" value="2026-02-21"></div>
                <div class="md:col-span-2"><label class="label-text">Adresa inštalácie</label><input type="text" id="address" class="input-field" placeholder="Miesto realizácie"></div>
                <div><label class="label-text">Meno Zákazníka</label><input type="text" id="customerName" class="input-field"></div>
                <div><label class="label-text">Telefónny kontakt</label><input type="tel" id="customerPhone" class="input-field"></div>
                <div><label class="label-text">Značka / Výrobca</label><input type="text" id="manufacturer" class="input-field" placeholder="napr. Vaillant"></div>
            </div>

            <!-- SEKCIA: TEPELNÉ ČERPADLO -->
            <div id="section-tc" class="device-section active">
                <div class="section-header">02. Merania - Tepelné čerpadlo</div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-1.5 mb-4">
                    <div class="bg-slate-50 p-3 rounded-lg border">
                        <label class="label-text">Vonkajšia j. (Model / SN)</label>
                        <input type="text" id="tc_ext_model" class="input-field font-bold">
                    </div>
                    <div class="bg-slate-50 p-3 rounded-lg border">
                        <label class="label-text">Vnútorná j. (Model / SN)</label>
                        <input type="text" id="tc_int_model" class="input-field font-bold">
                    </div>
                </div>

                <div class="p-1.5 overflow-x-auto">
                    <table class="min-w-[600px] w-full measuring-table text-xs">
                        <thead>
                            <tr>
                                <th rowspan="2">Stav zariadenia</th>
                                <th colspan="3">Medzi fázami (V)</th>
                                <th colspan="3">Fáza voči Nule (V)</th>
                            </tr>
                            <tr><th>L1/L2</th><th>L2/L3</th><th>L3/L1</th><th>L1/N</th><th>L2/N</th><th>L3/N</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="p-2 font-bold bg-slate-50 text-[10px]">Vypnuté</td>
                                <td><input type="text" id="volt_off_12" class="bg-transparent"></td>
                                <td><input type="text" id="volt_off_23" class="bg-transparent"></td>
                                <td><input type="text" id="volt_off_31" class="bg-transparent"></td>
                                <td><input type="text" id="volt_off_1n" class="bg-transparent"></td>
                                <td><input type="text" id="volt_off_2n" class="bg-transparent"></td>
                                <td><input type="text" id="volt_off_3n" class="bg-transparent"></td>
                            </tr>
                            <tr>
                                <td class="p-2 font-bold bg-slate-50 text-red-600 text-[10px]">V Prevádzke</td>
                                <td><input type="text" id="volt_on_12" class="bg-transparent text-red-600"></td>
                                <td><input type="text" id="volt_on_23" class="bg-transparent text-red-600"></td>
                                <td><input type="text" id="volt_on_31" class="bg-transparent text-red-600"></td>
                                <td><input type="text" id="volt_on_1n" class="bg-transparent text-red-600"></td>
                                <td><input type="text" id="volt_on_2n" class="bg-transparent text-red-600"></td>
                                <td><input type="text" id="volt_on_3n" class="bg-transparent text-red-600"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-1.5 mt-4">
                    <div class="bg-slate-50 p-3 rounded-lg border">
                        <label class="label-text">Prevádzkový prúd (A)</label>
                        <div class="grid grid-cols-3 gap-3">
                            <div><label class="text-[9px] font-bold">L1</label><input type="text" id="amp_l1" class="input-field text-center font-bold text-red-600"></div>
                            <div><label class="text-[9px] font-bold">L2</label><input type="text" id="amp_l2" class="input-field text-center font-bold text-red-600"></div>
                            <div><label class="text-[9px] font-bold">L3</label><input type="text" id="amp_l3" class="input-field text-center font-bold text-red-600"></div>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-lg border">
                        <label class="label-text">Tlaky chladiva (bar)</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-[9px] font-bold">Vysoký (HP)</label><input type="text" id="press_hp" class="input-field text-center font-bold"></div>
                            <div><label class="text-[9px] font-bold">Nízky (LP)</label><input type="text" id="press_lp" class="input-field text-center font-bold"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEKCIE OSTATNÝCH ZARIADENÍ (Zjednodušené pre Cloud demo) -->
            <div id="section-plyn" class="device-section">
                <div class="section-header">02. Analýza - Plynový kotol</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-1.5">
                    <div class="bg-slate-50 p-3 rounded-lg border"><label class="label-text">Model a SN</label><input type="text" id="gas_model" class="input-field"></div>
                    <div class="bg-slate-50 p-3 rounded-lg border"><label class="label-text">CO2 (%)</label><input type="text" id="gas_co2" class="input-field text-red-600 font-bold"></div>
                </div>
            </div>
            
            <div id="section-elektro" class="device-section">
                <div class="section-header">02. Elektrický kotol</div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-1.5"><input type="text" id="el_l1" class="input-field" placeholder="L1 (A)"><input type="text" id="el_l2" class="input-field" placeholder="L2 (A)"><input type="text" id="el_l3" class="input-field" placeholder="L3 (A)"></div>
            </div>

            <div id="section-pelety" class="device-section">
                <div class="section-header">02. Peletový kotol</div>
                <div class="grid grid-cols-2 gap-4 p-1.5"><input type="text" id="pel_eff" class="input-field" placeholder="Účinnosť (%)"><input type="text" id="pel_temp" class="input-field" placeholder="Spaliny (°C)"></div>
            </div>

            <!-- SPOLOČNÁ ELEKTRIKA -->
            <div class="section-header">03. Inštalácia a Káble</div>
            <div class="p-1.5 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-slate-50 p-3 border rounded-lg">
                    <label class="label-text text-red-600 font-black">Istenie:</label>
                    <input type="text" id="protection" class="input-field border-red-200" placeholder="napr. B25/3">
                </div>
                <div class="bg-slate-50 p-3 border rounded-lg">
                    <label class="label-text">Kábel napájania:</label>
                    <input type="text" id="cable_power" class="input-field">
                </div>
            </div>

            <!-- CERTIFIKÁTY -->
            <div class="mt-8 p-5 border border-red-200 bg-red-50 rounded-xl">
                <h3 class="text-[11px] font-black uppercase text-red-600 italic mb-2 border-b border-red-200 pb-1">Odborné prehlásenie</h3>
                <p class="text-[10px] md:text-[8.5px] leading-relaxed text-slate-700 italic mb-4">
                    Zariadenie odovzdané ako funkčný celok podľa STN EN 378 a STN 33 2000-6. Užívateľ zaškolený.
                </p>
                <div class="grid grid-cols-3 gap-2">
                    <div class="bg-white p-2 rounded border text-[10px] font-bold">Chladiar: 10637</div>
                    <div class="bg-white p-2 rounded border text-[10px] font-bold">Elektro: 18122868</div>
                    <div class="bg-white p-2 rounded border text-[10px] font-bold tracking-tighter">Plyn: 077/2/2021</div>
                </div>
            </div>

            <!-- DIGITÁLNE PODPISY -->
            <div class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="flex flex-col items-center">
                    <label class="label-text mb-2 tracking-widest text-slate-400 uppercase">Podpis zákazníka</label>
                    <div class="w-full relative">
                        <canvas id="customerSignature" class="signature-pad shadow-inner"></canvas>
                        <button type="button" onclick="clearSignature('customerSignature')" class="no-print absolute top-2 right-2 text-[10px] bg-white/90 px-3 py-1.5 rounded-full border shadow-sm font-bold">VYMAZAŤ</button>
                    </div>
                </div>
                <div class="flex flex-col items-center">
                    <label class="label-text mb-2 tracking-widest text-red-600 italic uppercase">Podpis technika</label>
                    <div class="w-full relative">
                        <canvas id="technicianSignature" class="signature-pad shadow-inner border-red-100"></canvas>
                        <button type="button" onclick="clearSignature('technicianSignature')" class="no-print absolute top-2 right-2 text-[10px] bg-white/90 px-3 py-1.5 rounded-full border shadow-sm font-bold text-red-600">VYMAZAŤ</button>
                    </div>
                </div>
            </div>

            <!-- OVLÁDACIE PRVKY -->
            <div class="mt-16 no-print flex flex-col items-center gap-4">
                <div class="flex flex-col md:flex-row gap-3 w-full justify-center">
                    <button type="button" id="btnSave" class="bg-zinc-800 text-white px-10 py-5 rounded-full font-[900] text-sm shadow-xl hover:bg-black transition-all transform active:scale-95 uppercase tracking-widest flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z" /><path d="M9 13h2v5a1 1 0 11-2 0v-5z" /></svg>
                        Uložiť do cloudu
                    </button>
                    <button type="button" onclick="window.print()" class="bg-red-600 text-white px-10 py-5 rounded-full font-[900] text-sm shadow-xl hover:bg-red-700 transition-all transform active:scale-95 uppercase tracking-widest">
                        Vytlačiť do PDF
                    </button>
                </div>
                <p class="text-[9px] text-slate-400 uppercase font-black tracking-[0.2em]">Spektra Install Cloud Sync</p>
            </div>
        </form>
    </div>
    
    <footer class="mt-10 mb-20 text-center text-slate-400 text-[8px] font-black uppercase no-print tracking-[0.4em]">Spektra v3.4 Cloud | &copy; 2026</footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by environment
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;

        // AUTH INITIALIZATION
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error", error);
                showToast("Chyba pripojenia k cloudu.");
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                console.log("Logged in as:", user.uid);
            }
        });

        initAuth();

        // SIGNATURE PADS
        const pads = {};
        function initPad(id) {
            const canvas = document.getElementById(id);
            const ctx = canvas.getContext('2d');
            let drawing = false;
            ctx.strokeStyle = "#1e293b";
            ctx.lineWidth = 3;
            ctx.lineCap = "round";

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                return { x, y };
            };

            const start = (e) => { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); if(e.touches) e.preventDefault(); };
            const move = (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); if(e.touches) e.preventDefault(); };
            const stop = () => drawing = false;

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', move);
            window.addEventListener('mouseup', stop);
            canvas.addEventListener('touchstart', start, {passive: false});
            canvas.addEventListener('touchmove', move, {passive: false});
            canvas.addEventListener('touchend', stop);

            pads[id] = { canvas, ctx };
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }

        window.clearSignature = (id) => {
            const pad = pads[id];
            pad.ctx.clearRect(0, 0, pad.canvas.width, pad.canvas.height);
        };

        initPad('customerSignature');
        initPad('technicianSignature');

        // CLOUD SAVING
        document.getElementById('btnSave').onclick = async () => {
            if (!currentUser) {
                showToast("Čakám na pripojenie...");
                return;
            }

            const pId = document.getElementById('protocolId').value.trim();
            if (!pId) {
                showToast("Zadajte číslo protokolu!");
                return;
            }

            showToast("Ukladám...");

            // Collect all inputs
            const data = {
                metadata: {
                    protocolId: pId,
                    type: document.getElementById('deviceSelector').value,
                    timestamp: new Date().toISOString(),
                    savedBy: currentUser.uid
                },
                content: {}
            };

            // Scrape all inputs with IDs
            document.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.id && el.id !== 'protocolId') {
                    data.content[el.id] = el.type === 'checkbox' ? el.checked : el.value;
                }
            });

            // Scrape signatures
            data.signatures = {
                customer: document.getElementById('customerSignature').toDataURL(),
                technician: document.getElementById('technicianSignature').toDataURL()
            };

            try {
                // RULE 1: Strict Path
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'protocols', pId);
                await setDoc(docRef, data);
                showToast("✅ Protokol uložený do cloudu!");
            } catch (e) {
                console.error(e);
                showToast("❌ Chyba pri ukladaní.");
            }
        };

        function showToast(msg) {
            const x = document.getElementById("toast");
            x.innerHTML = msg;
            x.className = "show";
            setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
        }

        window.updateDeviceView = () => {
            const selected = document.getElementById('deviceSelector').value;
            document.querySelectorAll('.device-section').forEach(s => s.classList.remove('active'));
            document.getElementById('section-' + selected).classList.add('active');
        };
    </script>
</body>
</html>
